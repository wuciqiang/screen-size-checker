// mobile-performance-optimizer.js - ÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñÊ†∏ÂøÉÁ≥ªÁªü

/**
 * ÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñÊ†∏ÂøÉÁ≥ªÁªü
 * Ê£ÄÊµãÁßªÂä®ËÆæÂ§á„ÄÅËØÑ‰º∞ËÆæÂ§áËÉΩÂäõ„ÄÅÂÆûÁé∞Ëá™ÈÄÇÂ∫î‰ºòÂåñÁ≠ñÁï•
 */
class MobilePerformanceOptimizer {
    constructor(config = {}) {
        this.config = {
            enableDeviceDetection: true,
            enableNetworkAdaptation: true,
            enableLowEndOptimization: true,
            debugMode: false,
            ...config
        };

        // ËÆæÂ§á‰ø°ÊÅØ
        this.deviceInfo = {
            isMobile: false,
            isTablet: false,
            isLowEnd: false,
            screenSize: 'unknown',
            orientation: 'unknown'
        };

        // ËÆæÂ§áËÉΩÂäõËØÑ‰º∞
        this.deviceCapabilities = {
            memory: 4,
            cores: 4,
            connectionType: 'unknown',
            downlink: 10,
            rtt: 100,
            saveData: false
        };

        // ‰ºòÂåñÁ∫ßÂà´
        this.optimizationLevel = 'light';

        // ‰ºòÂåñÁ≠ñÁï•ÈÖçÁΩÆ
        this.optimizationStrategies = {
            aggressive: {
                maxConcurrentRequests: 2,
                imageQuality: 0.7,
                disableAnimations: true,
                simplifyUI: true,
                enableDataSaving: true,
                deferAllNonCritical: true
            },
            moderate: {
                maxConcurrentRequests: 4,
                imageQuality: 0.8,
                reduceAnimations: true,
                enableDataSaving: false,
                deferNonCritical: true
            },
            light: {
                maxConcurrentRequests: 6,
                imageQuality: 0.9,
                enablePreloading: true,
                enableDataSaving: false,
                deferNonCritical: false
            }
        };

        // ÊÄßËÉΩÁõëÊéß
        this.performanceMetrics = {
            initTime: 0,
            optimizationTime: 0,
            memoryUsage: 0,
            networkRequests: 0
        };

        // ‰∏éÁé∞ÊúâÊÄßËÉΩÁõëÊéßÁ≥ªÁªüÈõÜÊàê
        this.performanceMonitor = null;

        // ÂàùÂßãÂåñ
        this.initialize();
    }

    /**
     * ÂàùÂßãÂåñÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñÁ≥ªÁªü
     */
    async initialize() {
        const startTime = performance.now();

        try {
            console.log('üöÄ Initializing Mobile Performance Optimizer...');

            // Ê£ÄÊµãÁßªÂä®ËÆæÂ§á
            await this.detectMobileDevice();

            // ËØÑ‰º∞ËÆæÂ§áËÉΩÂäõ
            await this.assessDeviceCapabilities();

            // Ëé∑ÂèñÁΩëÁªú‰ø°ÊÅØ
            await this.getNetworkInfo();

            // Á°ÆÂÆö‰ºòÂåñÁ∫ßÂà´
            this.determineOptimizationLevel();

            // Â∫îÁî®ÁßªÂä®Á´Ø‰ºòÂåñ
            await this.applyMobileOptimizations();

            this.performanceMetrics.initTime = performance.now() - startTime;

            if (this.config.debugMode) {
                this.logOptimizationInfo();
            }

            // ÈõÜÊàêÁé∞ÊúâÊÄßËÉΩÁõëÊéßÁ≥ªÁªü
            this.integrateWithPerformanceMonitor();

            console.log(`‚úÖ Mobile Performance Optimizer initialized in ${this.performanceMetrics.initTime.toFixed(2)}ms`);

        } catch (error) {
            console.error('‚ùå Error initializing Mobile Performance Optimizer:', error);
            // ÈôçÁ∫ßÂà∞Âü∫Á°Ä‰ºòÂåñ
            this.applyBasicMobileOptimizations();
        }
    }

    /**
     * Ê£ÄÊµãÁßªÂä®ËÆæÂ§á
     */
    async detectMobileDevice() {
        try {
            const userAgent = navigator.userAgent.toLowerCase();
            const mobileKeywords = [
                'android', 'webos', 'iphone', 'ipad', 'ipod',
                'blackberry', 'iemobile', 'opera mini', 'mobile'
            ];

            const isMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));
            const isMobileScreen = window.innerWidth <= 768;
            const hasTouchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            this.deviceInfo.isMobile = isMobileUA || (isMobileScreen && hasTouchSupport);
            this.deviceInfo.isTablet = /ipad|android(?!.*mobile)|tablet/i.test(userAgent) ||
                (window.innerWidth >= 768 && window.innerWidth <= 1024 && hasTouchSupport);

            const screenWidth = window.innerWidth;
            if (screenWidth <= 480) {
                this.deviceInfo.screenSize = 'small';
            } else if (screenWidth <= 768) {
                this.deviceInfo.screenSize = 'medium';
            } else if (screenWidth <= 1024) {
                this.deviceInfo.screenSize = 'large';
            } else {
                this.deviceInfo.screenSize = 'xlarge';
            }

            this.deviceInfo.orientation = window.innerHeight > window.innerWidth ? 'portrait' : 'landscape';

            console.log('üì± Device detection completed:', this.deviceInfo);
        } catch (error) {
            console.error('‚ùå Failed to detect mobile device:', error);
            this.deviceInfo.isMobile = window.innerWidth <= 768;
            this.deviceInfo.screenSize = window.innerWidth <= 480 ? 'small' : 'medium';
        }
    }

    /**
     * ËØÑ‰º∞ËÆæÂ§áËÉΩÂäõ
     */
    async assessDeviceCapabilities() {
        try {
            if ('deviceMemory' in navigator) {
                this.deviceCapabilities.memory = navigator.deviceMemory;
            } else {
                this.deviceCapabilities.memory = this.estimateDeviceMemory();
            }

            if ('hardwareConcurrency' in navigator) {
                this.deviceCapabilities.cores = navigator.hardwareConcurrency;
            }

            this.deviceInfo.isLowEnd = this.deviceCapabilities.memory < 4 ||
                this.deviceCapabilities.cores < 4 ||
                this.deviceInfo.screenSize === 'small';

            console.log('‚ö° Device capabilities assessed:', this.deviceCapabilities);
        } catch (error) {
            console.error('‚ùå Failed to assess device capabilities:', error);
            return {
                memory: 4,
                cores: 4,
                connectionType: 'unknown',
                isLowEnd: false
            };
        }
    }

    /**
     * ‰º∞ÁÆóËÆæÂ§áÂÜÖÂ≠ò
     */
    estimateDeviceMemory() {
        const userAgent = navigator.userAgent.toLowerCase();

        if (userAgent.includes('iphone')) {
            if (userAgent.includes('iphone os 15') || userAgent.includes('iphone os 16')) {
                return 6;
            } else if (userAgent.includes('iphone os 13') || userAgent.includes('iphone os 14')) {
                return 4;
            } else {
                return 3;
            }
        } else if (userAgent.includes('android')) {
            if (userAgent.includes('android 11') || userAgent.includes('android 12') || userAgent.includes('android 13')) {
                return 6;
            } else if (userAgent.includes('android 9') || userAgent.includes('android 10')) {
                return 4;
            } else {
                return 3;
            }
        }

        return this.deviceInfo.isMobile ? 3 : 8;
    }

    /**
     * Ëé∑ÂèñÁΩëÁªú‰ø°ÊÅØ
     */
    async getNetworkInfo() {
        try {
            const connection = navigator.connection ||
                navigator.mozConnection ||
                navigator.webkitConnection;

            if (connection) {
                this.deviceCapabilities.connectionType = connection.effectiveType || 'unknown';
                this.deviceCapabilities.downlink = connection.downlink || 10;
                this.deviceCapabilities.rtt = connection.rtt || 100;
                this.deviceCapabilities.saveData = connection.saveData || false;
            } else {
                this.estimateNetworkSpeed();
            }

            console.log('üåê Network info obtained:', {
                type: this.deviceCapabilities.connectionType,
                downlink: this.deviceCapabilities.downlink,
                rtt: this.deviceCapabilities.rtt,
                saveData: this.deviceCapabilities.saveData
            });
        } catch (error) {
            console.error('‚ùå Failed to get network info:', error);
            return {
                connectionType: 'unknown',
                downlink: 10,
                rtt: 100,
                saveData: false
            };
        }
    }

    /**
     * ‰º∞ÁÆóÁΩëÁªúÈÄüÂ∫¶
     */
    estimateNetworkSpeed() {
        const startTime = performance.now();

        const testImage = new Image();
        testImage.onload = () => {
            const loadTime = performance.now() - startTime;

            if (loadTime < 100) {
                this.deviceCapabilities.connectionType = '4g';
                this.deviceCapabilities.downlink = 10;
            } else if (loadTime < 300) {
                this.deviceCapabilities.connectionType = '3g';
                this.deviceCapabilities.downlink = 1.5;
            } else {
                this.deviceCapabilities.connectionType = '2g';
                this.deviceCapabilities.downlink = 0.5;
            }
        };

        testImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
    }

    /**
     * Á°ÆÂÆö‰ºòÂåñÁ∫ßÂà´
     */
    determineOptimizationLevel() {
        try {
            const { connectionType, saveData } = this.deviceCapabilities;
            const { isLowEnd } = this.deviceInfo;

            if (saveData ||
                connectionType === 'slow-2g' ||
                connectionType === '2g' ||
                isLowEnd) {
                this.optimizationLevel = 'aggressive';
            }
            else if (connectionType === '3g' ||
                this.deviceCapabilities.memory < 6 ||
                this.deviceInfo.screenSize === 'small') {
                this.optimizationLevel = 'moderate';
            }
            else {
                this.optimizationLevel = 'light';
            }

            console.log(`üéØ Optimization level determined: ${this.optimizationLevel}`);
        } catch (error) {
            console.error('‚ùå Failed to determine optimization level:', error);
            return 'light';
        }
    }

    /**
     * Â∫îÁî®ÁßªÂä®Á´Ø‰ºòÂåñ
     */
    async applyMobileOptimizations() {
        try {
            // Êõ¥‰∏•Ê†ºÁöÑËÆæÂ§áÊ£ÄÊµãÔºåÈÅøÂÖçÂú®Ê°åÈù¢Á´ØÈîôËØØÂ∫îÁî®ÁßªÂä®‰ºòÂåñ
            const isRealMobileDevice = this.isRealMobileDevice();
            const isDesktopBrowser = this.isDesktopBrowser();
            
            if (isDesktopBrowser) {
                console.log('üñ•Ô∏è Desktop browser detected, skipping all mobile optimizations');
                return;
            }

            if (!isRealMobileDevice && window.innerWidth > 768) {
                console.log('üì± Not a real mobile device and screen is large, skipping mobile optimizations');
                return;
            }

            if (this.isInDevToolsMobileMode()) {
                console.log('üîß Developer tools mobile mode detected, applying limited optimizations');
                this.applyLimitedMobileOptimizations();
                return;
            }

            // Âè™Âú®ÁúüÊ≠£ÁöÑÁßªÂä®ËÆæÂ§á‰∏äÂ∫îÁî®‰ºòÂåñ
            if (!isRealMobileDevice) {
                console.log('üì± Device detection uncertain, skipping mobile optimizations for safety');
                return;
            }

            const strategy = this.optimizationStrategies[this.optimizationLevel];
            console.log(`üîß Applying ${this.optimizationLevel} mobile optimizations on verified mobile device...`);

            this.applyBasicMobileOptimizations();

            switch (this.optimizationLevel) {
                case 'aggressive':
                    await this.applyAggressiveOptimizations(strategy);
                    break;
                case 'moderate':
                    await this.applyModerateOptimizations(strategy);
                    break;
                case 'light':
                    await this.applyLightOptimizations(strategy);
                    break;
            }

            console.log('‚úÖ Mobile optimizations applied successfully');
        } catch (error) {
            console.error('‚ùå Failed to apply mobile optimizations:', error);
            this.rollbackOptimizations();
        }
    }

    /**
     * Ê£ÄÊµãÊòØÂê¶‰∏∫ÁúüÊ≠£ÁöÑÁßªÂä®ËÆæÂ§á
     */
    isRealMobileDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        
        // Ê£ÄÊü•ÁúüÂÆûÁöÑÁßªÂä®ËÆæÂ§áÊ†áËØÜ
        const realMobilePatterns = [
            /android.*mobile/i,
            /iphone/i,
            /ipod/i,
            /blackberry/i,
            /iemobile/i,
            /opera mini/i,
            /mobile/i
        ];
        
        const hasRealMobileUA = realMobilePatterns.some(pattern => pattern.test(userAgent));
        const hasTouchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const hasSmallScreen = window.innerWidth <= 768;
        
        // ÂøÖÈ°ªÂêåÊó∂Êª°Ë∂≥ÔºöÁßªÂä®UA + Ëß¶Êë∏ÊîØÊåÅ + Â∞èÂ±èÂπï
        return hasRealMobileUA && hasTouchSupport && hasSmallScreen;
    }

    /**
     * Ê£ÄÊµãÊòØÂê¶‰∏∫Ê°åÈù¢ÊµèËßàÂô®
     */
    isDesktopBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        
        // Ê°åÈù¢ÊµèËßàÂô®ÁâπÂæÅ
        const desktopPatterns = [
            /windows nt/i,
            /macintosh/i,
            /linux.*x86/i,
            /chrome.*(?!mobile)/i,
            /firefox.*(?!mobile)/i,
            /safari.*(?!mobile)/i,
            /edge/i
        ];
        
        const hasDesktopUA = desktopPatterns.some(pattern => pattern.test(userAgent));
        const hasLargeScreen = window.innerWidth > 1024;
        const noTouchSupport = !('ontouchstart' in window) && navigator.maxTouchPoints === 0;
        
        // Ê°åÈù¢ÁâπÂæÅÔºöÊ°åÈù¢UA Êàñ (Â§ßÂ±èÂπï + Êó†Ëß¶Êë∏)
        return hasDesktopUA || (hasLargeScreen && noTouchSupport);
    }

    /**
     * Ê£ÄÊµãÊòØÂê¶Âú®ÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÁöÑÁßªÂä®Ê®°ÊãüÊ®°Âºè‰∏ã
     */
    isInDevToolsMobileMode() {
        const userAgent = navigator.userAgent;
        const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
        const isSmallScreen = window.innerWidth <= 768;

        return !isMobileUA && isSmallScreen;
    }

    /**
     * Â∫îÁî®ÊúâÈôêÁöÑÁßªÂä®‰ºòÂåñÔºàÂºÄÂèëËÄÖÂ∑•ÂÖ∑Ê®°ÂºèÔºâ
     */
    applyLimitedMobileOptimizations() {
        console.log('üîß Applying limited mobile optimizations for dev tools mode');

        document.documentElement.classList.add('mobile-optimized');
        document.documentElement.classList.add('dev-tools-mobile-mode');

        const style = document.createElement('style');
        style.setAttribute('data-mobile-optimizer', 'dev-tools-limited');
        style.textContent = `
            .dev-tools-mobile-mode * {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            .dev-tools-mobile-mode .container {
                max-width: 100%;
                padding: 0.5rem;
            }
        `;
        document.head.appendChild(style);
    }

    /**
     * Â∫îÁî®Âü∫Á°ÄÁßªÂä®Á´Ø‰ºòÂåñ
     */
    applyBasicMobileOptimizations() {
        try {
            this.optimizeViewport();
            this.optimizeTouchEvents();
            this.enableHardwareAcceleration();
            this.optimizeScrolling();

            document.documentElement.classList.add('mobile-optimized');

            if (this.deviceInfo.screenSize === 'small') {
                document.documentElement.classList.add('small-screen-optimized');
            } else if (this.deviceInfo.screenSize === 'medium') {
                document.documentElement.classList.add('medium-screen-optimized');
            }

            if (this.deviceInfo.isTablet) {
                document.documentElement.classList.add('tablet-device');
            }

            if (this.deviceInfo.isLowEnd) {
                document.documentElement.classList.add('low-end-device');
            }
        } catch (error) {
            console.error('‚ùå Failed to apply basic mobile optimizations:', error);
        }
    }

    /**
     * Â∫îÁî®ÊøÄËøõ‰ºòÂåñ
     */
    async applyAggressiveOptimizations(strategy) {
        try {
            console.log('üî• Applying aggressive optimizations...');

            document.documentElement.classList.add('reduce-motion', 'disable-animations');
            this.simplifyUI();
            this.enableDataSavingMode();
            this.deferAllNonCriticalResources();
            this.limitConcurrentRequests(strategy.maxConcurrentRequests);
            this.optimizeImageQuality(strategy.imageQuality);
            this.disableNonEssentialFeatures();
        } catch (error) {
            console.error('‚ùå Failed to apply aggressive optimizations:', error);
        }
    }

    /**
     * Â∫îÁî®‰∏≠Á≠â‰ºòÂåñ
     */
    async applyModerateOptimizations(strategy) {
        try {
            console.log('‚ö° Applying moderate optimizations...');

            document.documentElement.classList.add('reduce-animations');
            this.deferNonCriticalResources();
            this.limitConcurrentRequests(strategy.maxConcurrentRequests);
            this.optimizeImageQuality(strategy.imageQuality);
            this.enableLazyLoading();
        } catch (error) {
            console.error('‚ùå Failed to apply moderate optimizations:', error);
        }
    }

    /**
     * Â∫îÁî®ËΩªÂ∫¶‰ºòÂåñ
     */
    async applyLightOptimizations(strategy) {
        try {
            console.log('üí® Applying light optimizations...');

            this.preloadCriticalResources();
            this.enableResourcePrefetching();
            this.optimizeCaching();
        } catch (error) {
            console.error('‚ùå Failed to apply light optimizations:', error);
        }
    }

    /**
     * ‰ºòÂåñËßÜÂè£ÈÖçÁΩÆ
     */
    optimizeViewport() {
        try {
            // Âè™Âú®ÁúüÊ≠£ÁöÑÁßªÂä®ËÆæÂ§á‰∏ä‰ºòÂåñËßÜÂè£
            if (!this.isRealMobileDevice()) {
                console.log('üìê Not a real mobile device, skipping viewport optimization');
                return;
            }

            let viewport = document.querySelector('meta[name="viewport"]');

            if (viewport && viewport.content && viewport.content.includes('width=device-width')) {
                console.log('üìê Viewport already configured properly, no changes needed');
                return;
            }

            if (!viewport) {
                viewport = document.createElement('meta');
                viewport.name = 'viewport';
                document.head.appendChild(viewport);
            }

            let viewportContent = 'width=device-width, initial-scale=1';

            // Âè™Âú®‰ΩéÁ´ØËÆæÂ§á‰∏äÈôêÂà∂Áº©Êîæ
            if (this.deviceInfo.isLowEnd && this.deviceCapabilities.memory < 2) {
                viewportContent += ', user-scalable=no, maximum-scale=1, minimum-scale=1';
            }

            viewportContent += ', viewport-fit=cover';
            viewport.content = viewportContent;

            console.log('üìê Viewport optimized for mobile device:', viewportContent);
        } catch (error) {
            console.error('‚ùå Failed to optimize viewport:', error);
        }
    }

    /**
     * ‰ºòÂåñËß¶Êë∏‰∫ã‰ª∂
     */
    optimizeTouchEvents() {
        try {
            const style = document.createElement('style');
            style.setAttribute('data-mobile-optimizer', 'touch-events');
            style.textContent = `
                * {
                    touch-action: manipulation;
                }
                
                a, button, input, select, textarea, [role="button"] {
                    touch-action: manipulation;
                    -webkit-tap-highlight-color: transparent;
                }
                
                .scrollable, .overflow-auto, .overflow-scroll {
                    -webkit-overflow-scrolling: touch;
                    overscroll-behavior: contain;
                }
            `;
            document.head.appendChild(style);

            const passiveEvents = ['touchstart', 'touchmove', 'wheel', 'scroll'];
            passiveEvents.forEach(eventType => {
                document.addEventListener(eventType, () => { }, { passive: true });
            });

            console.log('üëÜ Touch events optimized');
        } catch (error) {
            console.error('‚ùå Failed to optimize touch interactions:', error);
        }
    }

    /**
     * ÂêØÁî®Á°¨‰ª∂Âä†ÈÄü
     */
    enableHardwareAcceleration() {
        try {
            const style = document.createElement('style');
            style.setAttribute('data-mobile-optimizer', 'hardware-acceleration');
            style.textContent = `
                .mobile-optimized .mobile-hw-accelerated {
                    transform: translateZ(0);
                    will-change: transform;
                    backface-visibility: hidden;
                }
                
                .mobile-optimized .mobile-animated {
                    transform: translate3d(0, 0, 0);
                    animation-fill-mode: both;
                }
                
                .low-end-device .mobile-animated,
                .low-end-device .animated {
                    animation: none !important;
                    transition: none !important;
                }
            `;
            document.head.appendChild(style);

            console.log('üöÄ Hardware acceleration enabled');
        } catch (error) {
            console.error('‚ùå Failed to apply hardware acceleration:', error);
        }
    }

    /**
     * ‰ºòÂåñÊªöÂä®ÊÄßËÉΩ
     */
    optimizeScrolling() {
        try {
            if (!this.deviceInfo.isLowEnd) {
                document.documentElement.style.scrollBehavior = 'smooth';
            }

            const scrollContainers = document.querySelectorAll('.scrollable, .overflow-auto');
            scrollContainers.forEach(container => {
                container.style.webkitOverflowScrolling = 'touch';
                container.style.overscrollBehavior = 'contain';
            });

            const style = document.createElement('style');
            style.setAttribute('data-mobile-optimizer', 'scrolling');
            style.textContent = `
                body {
                    overscroll-behavior-y: none;
                }
                
                .scroll-container {
                    contain: layout style paint;
                    overflow-anchor: none;
                }
                
                .low-end-device * {
                    scroll-behavior: auto !important;
                }
            `;
            document.head.appendChild(style);

            console.log('üìú Scrolling optimized');
        } catch (error) {
            console.error('‚ùå Failed to optimize scrolling:', error);
        }
    }

    /**
     * ÁÆÄÂåñUI
     */
    simplifyUI() {
        document.documentElement.classList.add('simplified-ui');

        const style = document.createElement('style');
        style.setAttribute('data-mobile-optimizer', 'simplified-ui');
        style.textContent = `
            .simplified-ui .decorative-element,
            .simplified-ui .non-essential-animation,
            .simplified-ui .complex-shadow {
                display: none !important;
            }
            
            .simplified-ui .info-card {
                box-shadow: none !important;
                border: 1px solid #e0e0e0;
            }
            
            .simplified-ui .gradient-background {
                background: #f5f5f5 !important;
            }
        `;
        document.head.appendChild(style);

        console.log('üé® UI simplified for low-end devices');
    }

    /**
     * ÂêØÁî®Êï∞ÊçÆËäÇÁúÅÊ®°Âºè
     */
    enableDataSavingMode() {
        document.documentElement.classList.add('data-saving-mode');

        const mediaElements = document.querySelectorAll('video, audio');
        mediaElements.forEach(media => {
            media.preload = 'none';
            media.autoplay = false;
        });

        const images = document.querySelectorAll('img');
        images.forEach(img => {
            if (!img.loading) {
                img.loading = 'lazy';
            }
        });

        console.log('üíæ Data saving mode enabled');
    }

    /**
     * Âª∂ËøüÈùûÂÖ≥ÈîÆËµÑÊ∫ê
     */
    deferNonCriticalResources() {
        const nonCriticalCSS = document.querySelectorAll('link[rel="stylesheet"][href*="blog"], link[rel="stylesheet"][href*="simulator"]');
        nonCriticalCSS.forEach(link => {
            link.media = 'print';
            link.onload = function () {
                this.media = 'all';
            };
        });

        console.log('‚è≥ Non-critical resources deferred (moderate)');
    }

    /**
     * ÂêØÁî®ËµÑÊ∫êÈ¢ÑÂèñ
     */
    enableResourcePrefetching() {
        const prefetchResources = [
            'css/blog.css',
            'css/simulator.css'
        ];

        prefetchResources.forEach(resource => {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = resource;
            document.head.appendChild(link);
        });

        console.log('üîÆ Resource prefetching enabled');
    }

    /**
     * ‰ºòÂåñÁºìÂ≠òÁ≠ñÁï•
     */
    optimizeCaching() {
        window.cacheOptimizationEnabled = true;
        console.log('üíæ Caching optimized');
    }

    /**
     * Âª∂ËøüÊâÄÊúâÈùûÂÖ≥ÈîÆËµÑÊ∫ê
     */
    deferAllNonCriticalResources() {
        const nonCriticalCSS = document.querySelectorAll('link[rel="stylesheet"]:not([data-critical])');
        nonCriticalCSS.forEach(link => {
            link.media = 'print';
            link.onload = function () {
                this.media = 'all';
            };
        });

        const nonCriticalJS = document.querySelectorAll('script:not([data-critical])');
        nonCriticalJS.forEach(script => {
            if (!script.async && !script.defer) {
                script.defer = true;
            }
        });

        console.log('‚è≥ Non-critical resources deferred');
    }

    /**
     * ÈôêÂà∂Âπ∂ÂèëËØ∑Ê±ÇÊï∞Èáè
     */
    limitConcurrentRequests(maxRequests) {
        window.maxConcurrentRequests = maxRequests;
        console.log(`üö¶ Concurrent requests limited to: ${maxRequests}`);
    }

    /**
     * ‰ºòÂåñÂõæÁâáË¥®Èáè
     */
    optimizeImageQuality(quality) {
        window.imageQuality = quality;

        const images = document.querySelectorAll('img');
        images.forEach(img => {
            img.dataset.quality = quality;
        });

        console.log(`üñºÔ∏è Image quality optimized to: ${quality}`);
    }

    /**
     * Á¶ÅÁî®ÈùûÂøÖË¶ÅÂäüËÉΩ
     */
    disableNonEssentialFeatures() {
        document.documentElement.classList.add('minimal-features');

        const autoRefreshElements = document.querySelectorAll('[data-auto-refresh]');
        autoRefreshElements.forEach(element => {
            element.removeAttribute('data-auto-refresh');
        });

        console.log('üö´ Non-essential features disabled');
    }

    /**
     * ÂêØÁî®ÊáíÂä†ËΩΩ
     */
    enableLazyLoading() {
        const images = document.querySelectorAll('img:not([loading])');
        images.forEach(img => {
            img.loading = 'lazy';
        });

        const iframes = document.querySelectorAll('iframe:not([loading])');
        iframes.forEach(iframe => {
            iframe.loading = 'lazy';
        });

        console.log('üîÑ Lazy loading enabled');
    }

    /**
     * È¢ÑÂä†ËΩΩÂÖ≥ÈîÆËµÑÊ∫ê
     */
    preloadCriticalResources() {
        const criticalResources = [
            'css/base.css',
            'css/main.css',
            'js/app.js'
        ];

        criticalResources.forEach(resource => {
            const link = document.createElement('link');
            link.rel = 'preload';

            if (resource.endsWith('.css')) {
                link.as = 'style';
            } else if (resource.endsWith('.js')) {
                link.as = 'script';
            }

            link.href = resource;
            document.head.appendChild(link);
        });

        console.log('‚ö° Critical resources preloaded');
    }

    /**
     * ÂõûÊªö‰ºòÂåñ
     */
    rollbackOptimizations() {
        try {
            const problematicClasses = [
                'mobile-optimized', 'low-end-device', 'reduce-motion',
                'disable-animations', 'simplified-ui', 'data-saving-mode'
            ];

            problematicClasses.forEach(className => {
                document.documentElement.classList.remove(className);
            });

            const optimizerStyles = document.querySelectorAll('style[data-mobile-optimizer]');
            optimizerStyles.forEach(style => {
                style.remove();
            });

            console.log('üîÑ Mobile optimizations rolled back');
        } catch (error) {
            console.error('‚ùå Failed to rollback optimizations:', error);
        }
    }

    /**
     * Ëé∑Âèñ‰ºòÂåñÁä∂ÊÄÅ
     */
    getOptimizationStatus() {
        try {
            return {
                isActive: document.documentElement.classList.contains('mobile-optimized'),
                level: this.optimizationLevel,
                deviceInfo: this.deviceInfo,
                capabilities: this.deviceCapabilities,
                metrics: this.performanceMetrics
            };
        } catch (error) {
            console.error('‚ùå Failed to get optimization status:', error);
            return {
                isActive: false,
                level: 'unknown',
                error: error.message
            };
        }
    }

    /**
     * Êõ¥Êñ∞ÊÄßËÉΩÊåáÊ†á
     */
    updatePerformanceMetrics() {
        try {
            if ('memory' in performance) {
                this.performanceMetrics.memoryUsage = performance.memory.usedJSHeapSize;
            }

            if ('getEntriesByType' in performance) {
                const resourceEntries = performance.getEntriesByType('resource');
                this.performanceMetrics.networkRequests = resourceEntries.length;
            }

            this.performanceMetrics.optimizationTime = performance.now() - this.performanceMetrics.initTime;
        } catch (error) {
            console.error('‚ùå Failed to update performance metrics:', error);
        }
    }

    /**
     * ËÆ∞ÂΩïÊÄßËÉΩÊï∞ÊçÆ
     */
    logPerformanceData() {
        try {
            if (this.config.debugMode) {
                console.group('üìä Mobile Performance Optimizer Status');
                console.log('Device Info:', this.deviceInfo);
                console.log('Capabilities:', this.deviceCapabilities);
                console.log('Optimization Level:', this.optimizationLevel);
                console.log('Performance Metrics:', this.performanceMetrics);
                console.groupEnd();
            }

            if (this.performanceMonitor) {
                this.performanceMonitor.recordCustomMetric('mobileOptimizationLevel', this.optimizationLevel);
                this.performanceMonitor.recordCustomMetric('mobileDeviceMemory', this.deviceCapabilities.memory);
                this.performanceMonitor.recordCustomMetric('mobileConnectionType', this.deviceCapabilities.connectionType);
            }
        } catch (error) {
            console.error('‚ùå Failed to log performance data:', error);
        }
    }

    /**
     * Ê∏ÖÁêÜËµÑÊ∫ê
     */
    cleanup() {
        try {
            console.log('üßπ Mobile Performance Optimizer cleaned up');
        } catch (error) {
            console.error('‚ùå Failed to cleanup resources:', error);
        }
    }

    /**
     * ÈõÜÊàêÁé∞ÊúâÊÄßËÉΩÁõëÊéßÁ≥ªÁªü
     */
    integrateWithPerformanceMonitor() {
        if (window.performanceMonitor) {
            this.performanceMonitor = window.performanceMonitor;
            console.log('üîó Integrated with existing performance monitor');
        }
    }

    /**
     * ËÆ∞ÂΩï‰ºòÂåñ‰ø°ÊÅØ
     */
    logOptimizationInfo() {
        console.group('üöÄ Mobile Performance Optimizer Status');
        console.log('Device Info:', this.deviceInfo);
        console.log('Capabilities:', this.deviceCapabilities);
        console.log('Optimization Level:', this.optimizationLevel);
        console.log('Performance Metrics:', this.performanceMetrics);
        console.groupEnd();
    }
}

// ÂØºÂá∫ÂáΩÊï∞‰æõÂÖ∂‰ªñÊ®°Âùó‰ΩøÁî®
window.MobilePerformanceOptimizer = MobilePerformanceOptimizer;

// ÂàõÂª∫ÂÖ®Â±ÄÂÆû‰æã
if (typeof window !== 'undefined') {
    window.mobilePerformanceOptimizer = new MobilePerformanceOptimizer({
        debugMode: false
    });
}

// ÂØºÂá∫‰ºòÂåñÁä∂ÊÄÅÊ£ÄÊü•ÂáΩÊï∞
window.getMobileOptimizationStatus = function() {
    if (window.mobilePerformanceOptimizer) {
        return window.mobilePerformanceOptimizer.getOptimizationStatus();
    }
    return { isActive: false, error: 'Mobile optimizer not initialized' };
};

// ÂØºÂá∫ËÆæÂ§áÊ£ÄÊµãÂáΩÊï∞
window.isMobileDevice = function() {
    if (window.mobilePerformanceOptimizer) {
        return window.mobilePerformanceOptimizer.isRealMobileDevice();
    }
    
    // ÁÆÄÂçïÁöÑÂêéÂ§áÊ£ÄÊµã
    const userAgent = navigator.userAgent.toLowerCase();
    const mobilePatterns = [/android.*mobile/i, /iphone/i, /ipod/i, /mobile/i];
    const hasMobileUA = mobilePatterns.some(pattern => pattern.test(userAgent));
    const hasSmallScreen = window.innerWidth <= 768;
    const hasTouchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    
    return hasMobileUA && hasSmallScreen && hasTouchSupport;
};

// ÂØºÂá∫Ê°åÈù¢Ê£ÄÊµãÂáΩÊï∞
window.isDesktopBrowser = function() {
    if (window.mobilePerformanceOptimizer) {
        return window.mobilePerformanceOptimizer.isDesktopBrowser();
    }
    
    // ÁÆÄÂçïÁöÑÂêéÂ§áÊ£ÄÊµã
    const userAgent = navigator.userAgent.toLowerCase();
    const desktopPatterns = [/windows nt/i, /macintosh/i, /linux.*x86/i];
    const hasDesktopUA = desktopPatterns.some(pattern => pattern.test(userAgent));
    const hasLargeScreen = window.innerWidth > 1024;
    const noTouchSupport = !('ontouchstart' in window) && navigator.maxTouchPoints === 0;
    
    return hasDesktopUA || (hasLargeScreen && noTouchSupport);
};

// console.log('üì± Mobile Performance Optimizer module loaded successfully'); Debug Info');
//         console.log('Configuration:', this.config);
//         console.log('Device Detection:', this.deviceInfo);
//         console.log('Device Capabilities:', this.deviceCapabilities);
//         console.log('Optimization Level:', this.optimizationLevel);
//         console.log('Applied Strategy:', this.optimizationStrategies[this.optimizationLevel]);
//         console.groupEnd();
//     }
// }

/**
 * ÂàùÂßãÂåñÁßªÂä®Á´Ø‰ºòÂåñÁöÑÂØºÂá∫ÂáΩÊï∞
 */
export function initializeMobileOptimization(config = {}) {
    try {
        if (typeof window === 'undefined') {
            console.warn('‚ö†Ô∏è Mobile optimization requires browser environment');
            return null;
        }

        // ÈÅøÂÖçÈáçÂ§çÂàùÂßãÂåñ
        if (window.mobilePerformanceOptimizer) {
            console.log('üì± Mobile Performance Optimizer already initialized');
            return window.mobilePerformanceOptimizer;
        }

        const optimizer = new MobilePerformanceOptimizer({
            debugMode: window.location.search.includes('debug=mobile'),
            ...config
        });

        window.mobilePerformanceOptimizer = optimizer;
        console.log('‚úÖ Mobile Performance Optimizer initialized via export');
        return optimizer;
    } catch (error) {
        console.error('‚ùå Failed to initialize mobile optimization:', error);
        return null;
    }
}

// Ëá™Âä®ÂàùÂßãÂåñÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñÂô®Ôºà‰øùÊåÅÂêëÂêéÂÖºÂÆπÔºâ
if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.mobilePerformanceOptimizer) {
                initializeMobileOptimization();
            }
        });
    } else {
        if (!window.mobilePerformanceOptimizer) {
            initializeMobileOptimization();
        }
    }
}

// ÂØºÂá∫Á±ªÂíåÂáΩÊï∞
export { MobilePerformanceOptimizer };
export default MobilePerformanceOptimizer;