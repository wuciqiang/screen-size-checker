<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主题切换调试测试</title>
    
    <!-- 引入实际的CSS文件 -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/base.css">
    
    <style>
        .debug-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--background-primary);
            color: var(--text-primary);
        }
        
        .debug-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--background-card);
        }
        
        .debug-info {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: var(--background-code);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            white-space: pre-wrap;
        }
        
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
            transition: background-color 0.3s ease;
        }
        
        .test-button:hover {
            background: var(--primary-hover);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        
        .console-output {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
            background: var(--background-code);
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .console-line {
            margin-bottom: 4px;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .console-error { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
        .console-warn { background: rgba(255, 193, 7, 0.1); color: #856404; }
        .console-info { background: rgba(23, 162, 184, 0.1); color: #0c5460; }
        .console-log { background: rgba(40, 167, 69, 0.1); color: #155724; }
    </style>
</head>
<body>
    <!-- 复制实际网站的header结构 -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-title"><a href="/" data-i18n="site_title">Screen Size Checker</a></div>
            </div>
            <nav class="main-nav">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/" class="nav-link" data-i18n="nav_home">首页</a>
                    </li>
                </ul>
            </nav>
            <div class="header-controls">
                <button class="language-button" id="language-modal-trigger" aria-label="Select language">
                    <span class="language-icon">🌐</span>
                    <span class="language-text" data-i18n="language_select_label">Language</span>
                </button>
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon">☀️</span>
                </button>
            </div>
        </div>
    </header>

    <div class="debug-container">
        <h1>主题切换功能调试测试</h1>
        <p>这个页面用于调试主题切换功能，使用实际的CSS和JavaScript文件。</p>
        
        <div class="debug-section">
            <h3>🎯 当前状态</h3>
            <p><span class="status-indicator" id="theme-status"></span>当前主题：<strong id="current-theme">检测中...</strong></p>
            <p><span class="status-indicator" id="button-status"></span>按钮点击次数：<strong id="click-count">0</strong></p>
            <p><span class="status-indicator" id="js-status"></span>JavaScript状态：<strong id="js-load-status">加载中...</strong></p>
            <p><span class="status-indicator" id="event-status"></span>事件绑定状态：<strong id="event-bind-status">检测中...</strong></p>
        </div>
        
        <div class="debug-section">
            <h3>🔍 详细调试信息</h3>
            <div class="debug-info" id="debug-details">检测中...</div>
        </div>
        
        <div class="debug-section">
            <h3>🧪 测试控制</h3>
            <button class="test-button" onclick="manualToggleTheme()">手动切换主题</button>
            <button class="test-button" onclick="resetTheme()">重置为浅色主题</button>
            <button class="test-button" onclick="updateDebugInfo()">刷新调试信息</button>
            <button class="test-button" onclick="testEventBinding()">测试事件绑定</button>
            <button class="test-button" onclick="clearConsole()">清空控制台</button>
        </div>
        
        <div class="debug-section">
            <h3>📊 控制台输出</h3>
            <div class="console-output" id="console-output">
                <div class="console-line console-info">[启动] 调试页面已加载</div>
            </div>
        </div>
    </div>

    <!-- 引入实际的JavaScript文件 -->
    <script type="module" src="js/app.js"></script>
    
    <script>
        let clickCount = 0;
        let loadTime = Date.now();
        let consoleMessages = [];
        
        // 拦截console方法以显示在页面上
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };
        
        function interceptConsole() {
            ['log', 'error', 'warn', 'info'].forEach(method => {
                console[method] = function(...args) {
                    originalConsole[method].apply(console, args);
                    
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' ');
                    
                    addConsoleMessage(method, message);
                };
            });
        }
        
        function addConsoleMessage(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleMessages.push({ type, message, timestamp });
            
            // 保持最新的50条消息
            if (consoleMessages.length > 50) {
                consoleMessages.shift();
            }
            
            updateConsoleDisplay();
        }
        
        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-output');
            if (consoleDiv) {
                consoleDiv.innerHTML = consoleMessages.map(msg => 
                    `<div class="console-line console-${msg.type}">[${msg.timestamp}] ${msg.message}</div>`
                ).join('');
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
        }
        
        function clearConsole() {
            consoleMessages = [];
            updateConsoleDisplay();
            console.info('控制台已清空');
        }
        
        // 更新调试信息
        function updateDebugInfo() {
            try {
                const dataThemeValue = document.documentElement.getAttribute('data-theme') || '未设置';
                const localStorageTheme = localStorage.getItem('theme') || '未设置';
                const computedBg = getComputedStyle(document.body).backgroundColor;
                const computedColor = getComputedStyle(document.body).color;
                const buttonCount = document.querySelectorAll('#theme-toggle').length;
                const themeButton = document.getElementById('theme-toggle');
                
                // 更新状态指示器
                document.getElementById('current-theme').textContent = dataThemeValue === 'dark' ? '深色主题' : '浅色主题';
                document.getElementById('click-count').textContent = clickCount;
                document.getElementById('js-load-status').textContent = typeof window.initializeApp === 'function' ? '已加载' : '未加载';
                
                // 检查事件绑定状态
                let eventStatus = '未绑定';
                if (themeButton) {
                    const listeners = getEventListeners ? getEventListeners(themeButton) : null;
                    if (listeners && listeners.click && listeners.click.length > 0) {
                        eventStatus = '已绑定';
                    } else if (themeButton.onclick) {
                        eventStatus = '已绑定(onclick)';
                    } else {
                        eventStatus = '未绑定';
                    }
                }
                document.getElementById('event-bind-status').textContent = eventStatus;
                
                // 更新状态指示器颜色
                document.getElementById('theme-status').className = `status-indicator ${dataThemeValue !== '未设置' ? 'status-ok' : 'status-error'}`;
                document.getElementById('button-status').className = `status-indicator ${clickCount > 0 ? 'status-ok' : 'status-warning'}`;
                document.getElementById('js-status').className = `status-indicator ${typeof window.initializeApp === 'function' ? 'status-ok' : 'status-error'}`;
                document.getElementById('event-status').className = `status-indicator ${eventStatus.includes('已绑定') ? 'status-ok' : 'status-error'}`;
                
                // 详细调试信息
                const debugDetails = `
主题属性 (data-theme): ${dataThemeValue}
本地存储主题: ${localStorageTheme}
计算样式背景色: ${computedBg}
计算样式文字色: ${computedColor}
主题切换按钮数量: ${buttonCount}
事件绑定状态: ${eventStatus}
页面加载时间: ${Date.now() - loadTime}ms
当前URL: ${window.location.href}
用户代理: ${navigator.userAgent.substring(0, 100)}...
                `.trim();
                
                document.getElementById('debug-details').textContent = debugDetails;
                
                console.log('调试信息已更新:', {
                    dataTheme: dataThemeValue,
                    localStorage: localStorageTheme,
                    buttonCount,
                    eventStatus,
                    computedBg,
                    computedColor
                });
            } catch (error) {
                console.error('更新调试信息时出错:', error);
            }
        }
        
        // 手动主题切换函数
        function manualToggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            console.log(`手动切换主题: ${currentTheme} -> ${newTheme}`);
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // 更新主题图标
            const themeIcon = document.querySelector('.theme-icon');
            if (themeIcon) {
                themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
            }
            
            clickCount++;
            updateDebugInfo();
        }
        
        // 重置主题
        function resetTheme() {
            console.log('重置主题到浅色');
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('theme', 'light');
            
            const themeIcon = document.querySelector('.theme-icon');
            if (themeIcon) {
                themeIcon.textContent = '🌙';
            }
            
            updateDebugInfo();
        }
        
        // 测试事件绑定
        function testEventBinding() {
            const themeButton = document.getElementById('theme-toggle');
            if (themeButton) {
                console.log('测试主题切换按钮点击...');
                themeButton.click();
                setTimeout(() => {
                    console.log('按钮点击测试完成');
                    updateDebugInfo();
                }, 100);
            } else {
                console.error('找不到主题切换按钮');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('调试页面DOM加载完成');
            interceptConsole();
            
            // 等待app.js加载完成
            setTimeout(() => {
                updateDebugInfo();
                
                // 监听主题切换按钮点击
                const themeButton = document.getElementById('theme-toggle');
                if (themeButton) {
                    // 添加额外的点击监听器来计数
                    themeButton.addEventListener('click', () => {
                        console.log('主题切换按钮被点击 (调试监听器)');
                        clickCount++;
                        setTimeout(updateDebugInfo, 100);
                    });
                    console.log('调试监听器已添加到主题切换按钮');
                } else {
                    console.error('找不到主题切换按钮');
                }
                
                // 定期更新调试信息
                setInterval(updateDebugInfo, 5000);
                
                console.log('调试系统初始化完成');
            }, 1000);
        });
        
        // 监听主题变化
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                    const newTheme = mutation.target.getAttribute('data-theme');
                    console.log(`检测到主题属性变化: ${newTheme}`);
                    updateDebugInfo();
                }
            });
        });
        
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['data-theme']
        });
        
        // 页面可见性变化时更新调试信息
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('页面重新可见，更新调试信息');
                updateDebugInfo();
            }
        });
    </script>
</body>
</html>