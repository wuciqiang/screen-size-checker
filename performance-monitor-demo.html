<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>性能监控系统演示</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .metric-card h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-value.good { color: #28a745; }
        .metric-value.needs-improvement { color: #ffc107; }
        .metric-value.poor { color: #dc3545; }
        
        .metric-description {
            font-size: 14px;
            color: #6c757d;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .test-section {
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
            margin-top: 30px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.active { background: #28a745; }
        .status-indicator.inactive { background: #dc3545; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 性能监控系统演示</h1>
        
        <div class="metric-card">
            <h3>
                <span id="monitor-status" class="status-indicator inactive"></span>
                监控系统状态
            </h3>
            <div id="system-status">正在初始化...</div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>LCP - 最大内容绘制</h3>
                <div id="lcp-value" class="metric-value">测量中...</div>
                <div class="metric-description">
                    衡量页面主要内容的加载速度<br>
                    目标: &lt; 2.5秒 (良好)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>FID - 首次输入延迟</h3>
                <div id="fid-value" class="metric-value">等待交互...</div>
                <div class="metric-description">
                    衡量页面交互响应速度<br>
                    目标: &lt; 100毫秒 (良好)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>CLS - 累积布局偏移</h3>
                <div id="cls-value" class="metric-value">监控中...</div>
                <div class="metric-description">
                    衡量页面布局稳定性<br>
                    目标: &lt; 0.1 (良好)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>FCP - 首次内容绘制</h3>
                <div id="fcp-value" class="metric-value">测量中...</div>
                <div class="metric-description">
                    衡量首次内容出现时间<br>
                    目标: &lt; 1.8秒 (良好)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>TTI - 可交互时间</h3>
                <div id="tti-value" class="metric-value">计算中...</div>
                <div class="metric-description">
                    衡量页面完全可交互时间<br>
                    目标: &lt; 3.8秒 (良好)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>性能评分</h3>
                <div id="score-value" class="metric-value">计算中...</div>
                <div class="metric-description">
                    基于 Core Web Vitals 的综合评分<br>
                    90+ 优秀, 70+ 良好, &lt;70 需改进
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="refreshMetrics()">🔄 刷新指标</button>
            <button onclick="simulateLongTask()">⏱️ 模拟长任务</button>
            <button onclick="triggerLayoutShift()">📐 触发布局偏移</button>
            <button onclick="showDetailedReport()">📊 详细报告</button>
        </div>
        
        <div class="test-section">
            <h3>📈 实时监控日志</h3>
            <div id="log-output" class="log-output">
                等待性能数据...
            </div>
            <button onclick="clearLog()">清空日志</button>
            <button onclick="exportData()">导出数据</button>
        </div>
        
        <div class="test-section">
            <h3>🧪 性能测试工具</h3>
            <p>使用以下工具测试不同的性能场景：</p>
            <button onclick="loadHeavyContent()">加载大量内容</button>
            <button onclick="simulateSlowNetwork()">模拟慢网络</button>
            <button onclick="stressTestDOM()">DOM 压力测试</button>
        </div>
    </div>
    
    <!-- 用于测试的隐藏内容 -->
    <div id="test-content" style="display: none;"></div>
    
    <script type="module">
        import { performanceMonitor } from './js/performance-monitor.js';
        
        // 全局变量
        window.performanceMonitor = performanceMonitor;
        let logMessages = [];
        
        // 日志函数
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push(logEntry);
            
            // 保持最新的50条日志
            if (logMessages.length > 50) {
                logMessages = logMessages.slice(-50);
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logOutput = document.getElementById('log-output');
            logOutput.textContent = logMessages.join('\n');
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // 更新指标显示
        function updateMetricsDisplay() {
            const metrics = performanceMonitor.getMetrics();
            const cwv = metrics.coreWebVitals;
            
            // 更新各项指标
            updateMetricDisplay('lcp', cwv.LCP);
            updateMetricDisplay('fid', cwv.FID);
            updateMetricDisplay('cls', cwv.CLS);
            updateMetricDisplay('fcp', cwv.FCP);
            updateMetricDisplay('tti', cwv.TTI);
            
            // 更新性能评分
            const score = metrics.performanceScore;
            const scoreElement = document.getElementById('score-value');
            scoreElement.textContent = `${score}/100`;
            scoreElement.className = `metric-value ${getScoreClass(score)}`;
            
            // 更新系统状态
            updateSystemStatus();
        }
        
        function updateMetricDisplay(metricName, metricData) {
            const element = document.getElementById(`${metricName}-value`);
            if (!element) return;
            
            if (metricData.value !== null) {
                const value = metricName === 'cls' ? 
                    metricData.value.toFixed(3) : 
                    `${metricData.value.toFixed(0)}ms`;
                
                element.textContent = value;
                element.className = `metric-value ${metricData.rating || 'unknown'}`;
            } else {
                element.textContent = metricName === 'fid' ? '等待交互...' : '测量中...';
                element.className = 'metric-value';
            }
        }
        
        function getScoreClass(score) {
            if (score >= 90) return 'good';
            if (score >= 70) return 'needs-improvement';
            return 'poor';
        }
        
        function updateSystemStatus() {
            const statusIndicator = document.getElementById('monitor-status');
            const statusText = document.getElementById('system-status');
            const isActive = performanceMonitor.isInitialized;
            
            statusIndicator.className = `status-indicator ${isActive ? 'active' : 'inactive'}`;
            
            if (isActive) {
                const observerCount = performanceMonitor.observers.size;
                statusText.innerHTML = `
                    ✅ 监控系统已激活<br>
                    📊 活跃观察器: ${observerCount}个<br>
                    🕐 运行时间: ${Math.round((performance.now() - performanceMonitor.startTime) / 1000)}秒
                `;
            } else {
                statusText.textContent = '❌ 监控系统未激活';
            }
        }
        
        // 全局函数
        window.refreshMetrics = function() {
            updateMetricsDisplay();
            addLog('📊 指标已刷新');
        };
        
        window.simulateLongTask = function() {
            addLog('⏱️ 开始模拟长任务...');
            
            // 模拟100ms的长任务
            const start = performance.now();
            while (performance.now() - start < 100) {
                // 阻塞主线程
            }
            
            setTimeout(() => {
                addLog('✅ 长任务模拟完成，检查长任务监控');
                updateMetricsDisplay();
            }, 100);
        };
        
        window.triggerLayoutShift = function() {
            addLog('📐 触发布局偏移...');
            
            const testContent = document.getElementById('test-content');
            testContent.style.display = 'block';
            testContent.innerHTML = `
                <div style="height: 200px; background: #ffeb3b; margin: 20px 0; padding: 20px; border-radius: 8px;">
                    <h3>动态添加的内容</h3>
                    <p>这个内容的突然出现会导致布局偏移，用于测试 CLS 监控。</p>
                </div>
            `;
            
            setTimeout(() => {
                testContent.style.display = 'none';
                addLog('✅ 布局偏移测试完成');
                updateMetricsDisplay();
            }, 2000);
        };
        
        window.showDetailedReport = function() {
            const metrics = performanceMonitor.getMetrics();
            console.log('📊 详细性能报告:', metrics);
            
            // 显示详细信息
            const report = JSON.stringify(metrics, null, 2);
            addLog('📊 详细报告已输出到控制台');
            
            // 创建弹窗显示报告摘要
            const summary = `
性能评分: ${metrics.performanceScore}/100
长任务数量: ${metrics.longTasksCount}
资源监控数量: ${metrics.resourceTimingsCount}
交互次数: ${metrics.userExperienceMetrics.interactionCount}
            `.trim();
            
            alert(`性能监控报告摘要:\n\n${summary}\n\n详细数据请查看浏览器控制台`);
        };
        
        window.clearLog = function() {
            logMessages = [];
            updateLogDisplay();
            addLog('🧹 日志已清空');
        };
        
        window.exportData = function() {
            const metrics = performanceMonitor.getMetrics();
            const exportData = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                metrics: metrics,
                logs: logMessages
            };
            
            console.log('📤 导出的性能数据:', exportData);
            
            // 创建下载链接
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `performance-data-${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            addLog('📤 性能数据已导出');
        };
        
        window.loadHeavyContent = function() {
            addLog('🔄 加载大量内容...');
            
            const testContent = document.getElementById('test-content');
            testContent.style.display = 'block';
            
            let heavyContent = '<div style="padding: 20px;">';
            for (let i = 0; i < 1000; i++) {
                heavyContent += `<div>测试内容行 ${i + 1} - 这是用于测试性能的大量内容</div>`;
            }
            heavyContent += '</div>';
            
            testContent.innerHTML = heavyContent;
            
            setTimeout(() => {
                testContent.style.display = 'none';
                addLog('✅ 大量内容加载测试完成');
                updateMetricsDisplay();
            }, 3000);
        };
        
        window.simulateSlowNetwork = function() {
            addLog('🐌 模拟慢网络加载...');
            
            // 加载一个大的测试图片
            const img = new Image();
            img.onload = () => {
                addLog('✅ 慢网络模拟完成');
                updateMetricsDisplay();
            };
            img.onerror = () => {
                addLog('❌ 网络测试失败');
            };
            
            // 使用一个较大的占位图片
            img.src = `https://picsum.photos/1200/800?random=${Date.now()}`;
        };
        
        window.stressTestDOM = function() {
            addLog('🧪 开始 DOM 压力测试...');
            
            const testContent = document.getElementById('test-content');
            testContent.style.display = 'block';
            
            // 创建大量DOM元素
            let domContent = '';
            for (let i = 0; i < 500; i++) {
                domContent += `
                    <div class="test-element-${i}" style="padding: 5px; margin: 2px; border: 1px solid #ccc;">
                        <span>元素 ${i}</span>
                        <button onclick="console.log('点击了元素 ${i}')">按钮 ${i}</button>
                    </div>
                `;
            }
            
            testContent.innerHTML = domContent;
            
            setTimeout(() => {
                testContent.style.display = 'none';
                addLog('✅ DOM 压力测试完成');
                updateMetricsDisplay();
            }, 5000);
        };
        
        // 初始化
        setTimeout(() => {
            addLog('🚀 性能监控演示页面已加载');
            addLog('📊 开始监控 Core Web Vitals...');
            updateMetricsDisplay();
        }, 1000);
        
        // 定期更新显示
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                updateMetricsDisplay();
            }
        }, 3000);
        
        // 监听性能事件
        if (typeof PerformanceObserver !== 'undefined') {
            addLog('✅ PerformanceObserver 支持已检测');
        } else {
            addLog('❌ 浏览器不支持 PerformanceObserver');
        }
        
        console.log('🎯 性能监控演示页面已准备就绪');
        console.log('可用的测试函数:', {
            refreshMetrics: '刷新性能指标',
            simulateLongTask: '模拟长任务',
            triggerLayoutShift: '触发布局偏移',
            showDetailedReport: '显示详细报告',
            loadHeavyContent: '加载大量内容',
            simulateSlowNetwork: '模拟慢网络',
            stressTestDOM: 'DOM压力测试'
        });
    </script>
</body>
</html>