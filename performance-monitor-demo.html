<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€§èƒ½ç›‘æ§ç³»ç»Ÿæ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .metric-card h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-value.good { color: #28a745; }
        .metric-value.needs-improvement { color: #ffc107; }
        .metric-value.poor { color: #dc3545; }
        
        .metric-description {
            font-size: 14px;
            color: #6c757d;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .test-section {
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
            margin-top: 30px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.active { background: #28a745; }
        .status-indicator.inactive { background: #dc3545; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ€§èƒ½ç›‘æ§ç³»ç»Ÿæ¼”ç¤º</h1>
        
        <div class="metric-card">
            <h3>
                <span id="monitor-status" class="status-indicator inactive"></span>
                ç›‘æ§ç³»ç»ŸçŠ¶æ€
            </h3>
            <div id="system-status">æ­£åœ¨åˆå§‹åŒ–...</div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>LCP - æœ€å¤§å†…å®¹ç»˜åˆ¶</h3>
                <div id="lcp-value" class="metric-value">æµ‹é‡ä¸­...</div>
                <div class="metric-description">
                    è¡¡é‡é¡µé¢ä¸»è¦å†…å®¹çš„åŠ è½½é€Ÿåº¦<br>
                    ç›®æ ‡: &lt; 2.5ç§’ (è‰¯å¥½)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>FID - é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ</h3>
                <div id="fid-value" class="metric-value">ç­‰å¾…äº¤äº’...</div>
                <div class="metric-description">
                    è¡¡é‡é¡µé¢äº¤äº’å“åº”é€Ÿåº¦<br>
                    ç›®æ ‡: &lt; 100æ¯«ç§’ (è‰¯å¥½)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>CLS - ç´¯ç§¯å¸ƒå±€åç§»</h3>
                <div id="cls-value" class="metric-value">ç›‘æ§ä¸­...</div>
                <div class="metric-description">
                    è¡¡é‡é¡µé¢å¸ƒå±€ç¨³å®šæ€§<br>
                    ç›®æ ‡: &lt; 0.1 (è‰¯å¥½)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>FCP - é¦–æ¬¡å†…å®¹ç»˜åˆ¶</h3>
                <div id="fcp-value" class="metric-value">æµ‹é‡ä¸­...</div>
                <div class="metric-description">
                    è¡¡é‡é¦–æ¬¡å†…å®¹å‡ºç°æ—¶é—´<br>
                    ç›®æ ‡: &lt; 1.8ç§’ (è‰¯å¥½)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>TTI - å¯äº¤äº’æ—¶é—´</h3>
                <div id="tti-value" class="metric-value">è®¡ç®—ä¸­...</div>
                <div class="metric-description">
                    è¡¡é‡é¡µé¢å®Œå…¨å¯äº¤äº’æ—¶é—´<br>
                    ç›®æ ‡: &lt; 3.8ç§’ (è‰¯å¥½)
                </div>
            </div>
            
            <div class="metric-card">
                <h3>æ€§èƒ½è¯„åˆ†</h3>
                <div id="score-value" class="metric-value">è®¡ç®—ä¸­...</div>
                <div class="metric-description">
                    åŸºäº Core Web Vitals çš„ç»¼åˆè¯„åˆ†<br>
                    90+ ä¼˜ç§€, 70+ è‰¯å¥½, &lt;70 éœ€æ”¹è¿›
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="refreshMetrics()">ğŸ”„ åˆ·æ–°æŒ‡æ ‡</button>
            <button onclick="simulateLongTask()">â±ï¸ æ¨¡æ‹Ÿé•¿ä»»åŠ¡</button>
            <button onclick="triggerLayoutShift()">ğŸ“ è§¦å‘å¸ƒå±€åç§»</button>
            <button onclick="showDetailedReport()">ğŸ“Š è¯¦ç»†æŠ¥å‘Š</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ˆ å®æ—¶ç›‘æ§æ—¥å¿—</h3>
            <div id="log-output" class="log-output">
                ç­‰å¾…æ€§èƒ½æ•°æ®...
            </div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª æ€§èƒ½æµ‹è¯•å·¥å…·</h3>
            <p>ä½¿ç”¨ä»¥ä¸‹å·¥å…·æµ‹è¯•ä¸åŒçš„æ€§èƒ½åœºæ™¯ï¼š</p>
            <button onclick="loadHeavyContent()">åŠ è½½å¤§é‡å†…å®¹</button>
            <button onclick="simulateSlowNetwork()">æ¨¡æ‹Ÿæ…¢ç½‘ç»œ</button>
            <button onclick="stressTestDOM()">DOM å‹åŠ›æµ‹è¯•</button>
        </div>
    </div>
    
    <!-- ç”¨äºæµ‹è¯•çš„éšè—å†…å®¹ -->
    <div id="test-content" style="display: none;"></div>
    
    <script type="module">
        import { performanceMonitor } from './js/performance-monitor.js';
        
        // å…¨å±€å˜é‡
        window.performanceMonitor = performanceMonitor;
        let logMessages = [];
        
        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push(logEntry);
            
            // ä¿æŒæœ€æ–°çš„50æ¡æ—¥å¿—
            if (logMessages.length > 50) {
                logMessages = logMessages.slice(-50);
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logOutput = document.getElementById('log-output');
            logOutput.textContent = logMessages.join('\n');
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        function updateMetricsDisplay() {
            const metrics = performanceMonitor.getMetrics();
            const cwv = metrics.coreWebVitals;
            
            // æ›´æ–°å„é¡¹æŒ‡æ ‡
            updateMetricDisplay('lcp', cwv.LCP);
            updateMetricDisplay('fid', cwv.FID);
            updateMetricDisplay('cls', cwv.CLS);
            updateMetricDisplay('fcp', cwv.FCP);
            updateMetricDisplay('tti', cwv.TTI);
            
            // æ›´æ–°æ€§èƒ½è¯„åˆ†
            const score = metrics.performanceScore;
            const scoreElement = document.getElementById('score-value');
            scoreElement.textContent = `${score}/100`;
            scoreElement.className = `metric-value ${getScoreClass(score)}`;
            
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            updateSystemStatus();
        }
        
        function updateMetricDisplay(metricName, metricData) {
            const element = document.getElementById(`${metricName}-value`);
            if (!element) return;
            
            if (metricData.value !== null) {
                const value = metricName === 'cls' ? 
                    metricData.value.toFixed(3) : 
                    `${metricData.value.toFixed(0)}ms`;
                
                element.textContent = value;
                element.className = `metric-value ${metricData.rating || 'unknown'}`;
            } else {
                element.textContent = metricName === 'fid' ? 'ç­‰å¾…äº¤äº’...' : 'æµ‹é‡ä¸­...';
                element.className = 'metric-value';
            }
        }
        
        function getScoreClass(score) {
            if (score >= 90) return 'good';
            if (score >= 70) return 'needs-improvement';
            return 'poor';
        }
        
        function updateSystemStatus() {
            const statusIndicator = document.getElementById('monitor-status');
            const statusText = document.getElementById('system-status');
            const isActive = performanceMonitor.isInitialized;
            
            statusIndicator.className = `status-indicator ${isActive ? 'active' : 'inactive'}`;
            
            if (isActive) {
                const observerCount = performanceMonitor.observers.size;
                statusText.innerHTML = `
                    âœ… ç›‘æ§ç³»ç»Ÿå·²æ¿€æ´»<br>
                    ğŸ“Š æ´»è·ƒè§‚å¯Ÿå™¨: ${observerCount}ä¸ª<br>
                    ğŸ• è¿è¡Œæ—¶é—´: ${Math.round((performance.now() - performanceMonitor.startTime) / 1000)}ç§’
                `;
            } else {
                statusText.textContent = 'âŒ ç›‘æ§ç³»ç»Ÿæœªæ¿€æ´»';
            }
        }
        
        // å…¨å±€å‡½æ•°
        window.refreshMetrics = function() {
            updateMetricsDisplay();
            addLog('ğŸ“Š æŒ‡æ ‡å·²åˆ·æ–°');
        };
        
        window.simulateLongTask = function() {
            addLog('â±ï¸ å¼€å§‹æ¨¡æ‹Ÿé•¿ä»»åŠ¡...');
            
            // æ¨¡æ‹Ÿ100msçš„é•¿ä»»åŠ¡
            const start = performance.now();
            while (performance.now() - start < 100) {
                // é˜»å¡ä¸»çº¿ç¨‹
            }
            
            setTimeout(() => {
                addLog('âœ… é•¿ä»»åŠ¡æ¨¡æ‹Ÿå®Œæˆï¼Œæ£€æŸ¥é•¿ä»»åŠ¡ç›‘æ§');
                updateMetricsDisplay();
            }, 100);
        };
        
        window.triggerLayoutShift = function() {
            addLog('ğŸ“ è§¦å‘å¸ƒå±€åç§»...');
            
            const testContent = document.getElementById('test-content');
            testContent.style.display = 'block';
            testContent.innerHTML = `
                <div style="height: 200px; background: #ffeb3b; margin: 20px 0; padding: 20px; border-radius: 8px;">
                    <h3>åŠ¨æ€æ·»åŠ çš„å†…å®¹</h3>
                    <p>è¿™ä¸ªå†…å®¹çš„çªç„¶å‡ºç°ä¼šå¯¼è‡´å¸ƒå±€åç§»ï¼Œç”¨äºæµ‹è¯• CLS ç›‘æ§ã€‚</p>
                </div>
            `;
            
            setTimeout(() => {
                testContent.style.display = 'none';
                addLog('âœ… å¸ƒå±€åç§»æµ‹è¯•å®Œæˆ');
                updateMetricsDisplay();
            }, 2000);
        };
        
        window.showDetailedReport = function() {
            const metrics = performanceMonitor.getMetrics();
            console.log('ğŸ“Š è¯¦ç»†æ€§èƒ½æŠ¥å‘Š:', metrics);
            
            // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            const report = JSON.stringify(metrics, null, 2);
            addLog('ğŸ“Š è¯¦ç»†æŠ¥å‘Šå·²è¾“å‡ºåˆ°æ§åˆ¶å°');
            
            // åˆ›å»ºå¼¹çª—æ˜¾ç¤ºæŠ¥å‘Šæ‘˜è¦
            const summary = `
æ€§èƒ½è¯„åˆ†: ${metrics.performanceScore}/100
é•¿ä»»åŠ¡æ•°é‡: ${metrics.longTasksCount}
èµ„æºç›‘æ§æ•°é‡: ${metrics.resourceTimingsCount}
äº¤äº’æ¬¡æ•°: ${metrics.userExperienceMetrics.interactionCount}
            `.trim();
            
            alert(`æ€§èƒ½ç›‘æ§æŠ¥å‘Šæ‘˜è¦:\n\n${summary}\n\nè¯¦ç»†æ•°æ®è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°`);
        };
        
        window.clearLog = function() {
            logMessages = [];
            updateLogDisplay();
            addLog('ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º');
        };
        
        window.exportData = function() {
            const metrics = performanceMonitor.getMetrics();
            const exportData = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                metrics: metrics,
                logs: logMessages
            };
            
            console.log('ğŸ“¤ å¯¼å‡ºçš„æ€§èƒ½æ•°æ®:', exportData);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `performance-data-${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            addLog('ğŸ“¤ æ€§èƒ½æ•°æ®å·²å¯¼å‡º');
        };
        
        window.loadHeavyContent = function() {
            addLog('ğŸ”„ åŠ è½½å¤§é‡å†…å®¹...');
            
            const testContent = document.getElementById('test-content');
            testContent.style.display = 'block';
            
            let heavyContent = '<div style="padding: 20px;">';
            for (let i = 0; i < 1000; i++) {
                heavyContent += `<div>æµ‹è¯•å†…å®¹è¡Œ ${i + 1} - è¿™æ˜¯ç”¨äºæµ‹è¯•æ€§èƒ½çš„å¤§é‡å†…å®¹</div>`;
            }
            heavyContent += '</div>';
            
            testContent.innerHTML = heavyContent;
            
            setTimeout(() => {
                testContent.style.display = 'none';
                addLog('âœ… å¤§é‡å†…å®¹åŠ è½½æµ‹è¯•å®Œæˆ');
                updateMetricsDisplay();
            }, 3000);
        };
        
        window.simulateSlowNetwork = function() {
            addLog('ğŸŒ æ¨¡æ‹Ÿæ…¢ç½‘ç»œåŠ è½½...');
            
            // åŠ è½½ä¸€ä¸ªå¤§çš„æµ‹è¯•å›¾ç‰‡
            const img = new Image();
            img.onload = () => {
                addLog('âœ… æ…¢ç½‘ç»œæ¨¡æ‹Ÿå®Œæˆ');
                updateMetricsDisplay();
            };
            img.onerror = () => {
                addLog('âŒ ç½‘ç»œæµ‹è¯•å¤±è´¥');
            };
            
            // ä½¿ç”¨ä¸€ä¸ªè¾ƒå¤§çš„å ä½å›¾ç‰‡
            img.src = `https://picsum.photos/1200/800?random=${Date.now()}`;
        };
        
        window.stressTestDOM = function() {
            addLog('ğŸ§ª å¼€å§‹ DOM å‹åŠ›æµ‹è¯•...');
            
            const testContent = document.getElementById('test-content');
            testContent.style.display = 'block';
            
            // åˆ›å»ºå¤§é‡DOMå…ƒç´ 
            let domContent = '';
            for (let i = 0; i < 500; i++) {
                domContent += `
                    <div class="test-element-${i}" style="padding: 5px; margin: 2px; border: 1px solid #ccc;">
                        <span>å…ƒç´  ${i}</span>
                        <button onclick="console.log('ç‚¹å‡»äº†å…ƒç´  ${i}')">æŒ‰é’® ${i}</button>
                    </div>
                `;
            }
            
            testContent.innerHTML = domContent;
            
            setTimeout(() => {
                testContent.style.display = 'none';
                addLog('âœ… DOM å‹åŠ›æµ‹è¯•å®Œæˆ');
                updateMetricsDisplay();
            }, 5000);
        };
        
        // åˆå§‹åŒ–
        setTimeout(() => {
            addLog('ğŸš€ æ€§èƒ½ç›‘æ§æ¼”ç¤ºé¡µé¢å·²åŠ è½½');
            addLog('ğŸ“Š å¼€å§‹ç›‘æ§ Core Web Vitals...');
            updateMetricsDisplay();
        }, 1000);
        
        // å®šæœŸæ›´æ–°æ˜¾ç¤º
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                updateMetricsDisplay();
            }
        }, 3000);
        
        // ç›‘å¬æ€§èƒ½äº‹ä»¶
        if (typeof PerformanceObserver !== 'undefined') {
            addLog('âœ… PerformanceObserver æ”¯æŒå·²æ£€æµ‹');
        } else {
            addLog('âŒ æµè§ˆå™¨ä¸æ”¯æŒ PerformanceObserver');
        }
        
        console.log('ğŸ¯ æ€§èƒ½ç›‘æ§æ¼”ç¤ºé¡µé¢å·²å‡†å¤‡å°±ç»ª');
        console.log('å¯ç”¨çš„æµ‹è¯•å‡½æ•°:', {
            refreshMetrics: 'åˆ·æ–°æ€§èƒ½æŒ‡æ ‡',
            simulateLongTask: 'æ¨¡æ‹Ÿé•¿ä»»åŠ¡',
            triggerLayoutShift: 'è§¦å‘å¸ƒå±€åç§»',
            showDetailedReport: 'æ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š',
            loadHeavyContent: 'åŠ è½½å¤§é‡å†…å®¹',
            simulateSlowNetwork: 'æ¨¡æ‹Ÿæ…¢ç½‘ç»œ',
            stressTestDOM: 'DOMå‹åŠ›æµ‹è¯•'
        });
    </script>
</body>
</html>