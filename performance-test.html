<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Monitor Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .metrics-display {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        
        .status.good {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.needs-improvement {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.poor {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .large-content {
            height: 1000px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Performance Monitor Test Page</h1>
    
    <div class="test-section">
        <h2>Performance Monitor Status</h2>
        <div id="monitor-status">Initializing...</div>
        <button onclick="checkMonitorStatus()">Check Status</button>
        <button onclick="refreshMetrics()">Refresh Metrics</button>
    </div>
    
    <div class="test-section">
        <h2>Core Web Vitals</h2>
        <div id="cwv-display" class="metrics-display">Loading...</div>
        <button onclick="displayCoreWebVitals()">Update Core Web Vitals</button>
    </div>
    
    <div class="test-section">
        <h2>Performance Score</h2>
        <div id="score-display" class="status">Calculating...</div>
        <button onclick="calculateScore()">Calculate Score</button>
    </div>
    
    <div class="test-section">
        <h2>Long Task Test</h2>
        <p>Click the button below to simulate a long task (>50ms) and test long task monitoring:</p>
        <button onclick="simulateLongTask()">Simulate Long Task</button>
        <div id="long-task-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Layout Shift Test</h2>
        <p>Click to add content that will cause layout shift (CLS test):</p>
        <button onclick="causeLayoutShift()">Cause Layout Shift</button>
        <div id="dynamic-content"></div>
    </div>
    
    <div class="test-section">
        <h2>Resource Loading Test</h2>
        <p>Load additional resources to test resource timing monitoring:</p>
        <button onclick="loadTestResources()">Load Test Resources</button>
        <div id="resource-status"></div>
    </div>
    
    <div class="test-section">
        <h2>All Metrics Summary</h2>
        <div id="all-metrics" class="metrics-display">Click "Show All Metrics" to display</div>
        <button onclick="showAllMetrics()">Show All Metrics</button>
        <button onclick="exportMetrics()">Export to Console</button>
    </div>
    
    <!-- Large content to test LCP -->
    <div class="large-content">
        <div>Large Content for LCP Testing</div>
    </div>
    
    <script type="module">
        import { performanceMonitor } from './js/performance-monitor.js';
        
        // Make performanceMonitor globally available for testing
        window.performanceMonitor = performanceMonitor;
        
        // Test functions
        window.checkMonitorStatus = function() {
            const statusDiv = document.getElementById('monitor-status');
            const isInitialized = performanceMonitor.isInitialized;
            const observerCount = performanceMonitor.observers.size;
            
            statusDiv.innerHTML = `
                <strong>Status:</strong> ${isInitialized ? '✅ Initialized' : '❌ Not Initialized'}<br>
                <strong>Active Observers:</strong> ${observerCount}<br>
                <strong>Config:</strong> ${JSON.stringify(performanceMonitor.config, null, 2)}
            `;
        };
        
        window.displayCoreWebVitals = function() {
            const cwvDiv = document.getElementById('cwv-display');
            const metrics = performanceMonitor.getMetrics();
            const cwv = metrics.coreWebVitals;
            
            let display = '';
            for (const [metric, data] of Object.entries(cwv)) {
                const value = data.value !== null ? data.value.toFixed(2) : 'Not measured';
                const rating = data.rating || 'unknown';
                const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : 'N/A';
                
                display += `${metric}: ${value}ms (${rating}) - ${timestamp}\n`;
            }
            
            cwvDiv.textContent = display || 'No Core Web Vitals data available yet';
        };
        
        window.calculateScore = function() {
            const scoreDiv = document.getElementById('score-display');
            const score = performanceMonitor.getMetrics().performanceScore;
            
            let className = 'poor';
            let message = '';
            
            if (score >= 90) {
                className = 'good';
                message = 'Excellent performance!';
            } else if (score >= 70) {
                className = 'needs-improvement';
                message = 'Good performance, room for improvement';
            } else {
                className = 'poor';
                message = 'Performance needs significant improvement';
            }
            
            scoreDiv.className = `status ${className}`;
            scoreDiv.innerHTML = `
                <strong>Performance Score: ${score}/100</strong><br>
                ${message}
            `;
        };
        
        window.simulateLongTask = function() {
            const statusDiv = document.getElementById('long-task-status');
            statusDiv.textContent = 'Simulating long task...';
            
            // Simulate a long task (blocking the main thread)
            const start = performance.now();
            while (performance.now() - start < 100) {
                // Busy wait to block the main thread
            }
            
            setTimeout(() => {
                const metrics = performanceMonitor.getMetrics();
                const longTaskCount = metrics.longTasksCount || 0;
                statusDiv.innerHTML = `
                    <strong>Long task completed!</strong><br>
                    Total long tasks detected: ${longTaskCount}
                `;
            }, 100);
        };
        
        window.causeLayoutShift = function() {
            const contentDiv = document.getElementById('dynamic-content');
            const newElement = document.createElement('div');
            newElement.style.cssText = `
                height: 100px;
                background: #ffeb3b;
                margin: 10px 0;
                padding: 20px;
                border-radius: 5px;
                animation: slideIn 0.3s ease-out;
            `;
            newElement.textContent = 'This content was added dynamically and may cause layout shift';
            
            // Add CSS animation
            if (!document.getElementById('slide-animation')) {
                const style = document.createElement('style');
                style.id = 'slide-animation';
                style.textContent = `
                    @keyframes slideIn {
                        from { height: 0; padding: 0; margin: 0; opacity: 0; }
                        to { height: 100px; padding: 20px; margin: 10px 0; opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            contentDiv.appendChild(newElement);
            
            // Check CLS after a delay
            setTimeout(() => {
                displayCoreWebVitals();
            }, 500);
        };
        
        window.loadTestResources = function() {
            const statusDiv = document.getElementById('resource-status');
            statusDiv.textContent = 'Loading test resources...';
            
            // Load a test image
            const img = new Image();
            img.onload = () => {
                statusDiv.innerHTML += '<br>✅ Test image loaded';
            };
            img.onerror = () => {
                statusDiv.innerHTML += '<br>❌ Test image failed to load';
            };
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwN2NiYSIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VGVzdDwvdGV4dD48L3N2Zz4=';
            
            // Load a test CSS file
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'data:text/css;base64,LyogVGVzdCBDU1MgKi8gLnRlc3QgeyBjb2xvcjogcmVkOyB9';
            link.onload = () => {
                statusDiv.innerHTML += '<br>✅ Test CSS loaded';
            };
            link.onerror = () => {
                statusDiv.innerHTML += '<br>❌ Test CSS failed to load';
            };
            document.head.appendChild(link);
            
            // Check resource metrics after a delay
            setTimeout(() => {
                const metrics = performanceMonitor.getMetrics();
                const resourceCount = metrics.resourceTimingsCount || 0;
                statusDiv.innerHTML += `<br><strong>Total resources monitored: ${resourceCount}</strong>`;
            }, 1000);
        };
        
        window.showAllMetrics = function() {
            const metricsDiv = document.getElementById('all-metrics');
            const metrics = performanceMonitor.getMetrics();
            metricsDiv.textContent = JSON.stringify(metrics, null, 2);
        };
        
        window.exportMetrics = function() {
            const metrics = performanceMonitor.getMetrics();
            console.log('📊 Performance Metrics Export:', metrics);
            
            // Also check sessionStorage for reports
            const reports = JSON.parse(sessionStorage.getItem('performanceReports') || '[]');
            console.log('📊 Performance Reports:', reports);
            
            alert('Metrics exported to console. Check browser developer tools.');
        };
        
        window.refreshMetrics = function() {
            displayCoreWebVitals();
            calculateScore();
            showAllMetrics();
        };
        
        // Auto-refresh metrics every 5 seconds
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                displayCoreWebVitals();
                calculateScore();
            }
        }, 5000);
        
        // Initialize display after a short delay
        setTimeout(() => {
            checkMonitorStatus();
            displayCoreWebVitals();
            calculateScore();
        }, 1000);
        
        console.log('🧪 Performance Monitor Test Page Loaded');
        console.log('Available test functions:', {
            checkMonitorStatus: 'Check if performance monitor is initialized',
            displayCoreWebVitals: 'Show current Core Web Vitals metrics',
            calculateScore: 'Calculate and display performance score',
            simulateLongTask: 'Create a long task to test monitoring',
            causeLayoutShift: 'Add content to test CLS monitoring',
            loadTestResources: 'Load resources to test resource timing',
            showAllMetrics: 'Display all collected metrics',
            exportMetrics: 'Export metrics to console'
        });
    </script>
</body>
</html>